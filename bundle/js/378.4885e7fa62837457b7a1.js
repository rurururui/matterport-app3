/*! For license information please see 378.4885e7fa62837457b7a1.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[378],{25434:(i,e,t)=>{t.d(e,{Z:()=>s,u:()=>n});var a=t(89103);class n extends a.QB{constructor(i,e,t){super(),this.name=i,this.version=e,this.loadTime=t}}class s{constructor(){this.handlers=[{msgType:n,func:(i,e,t)=>{i.track("plugin_loaded",{name:e.name,version:e.version,time:e.loadTime})}}]}}},41122:(i,e,t)=>{t.d(e,{My:()=>r,W:()=>d,YB:()=>s,ho:()=>n,nq:()=>o,u3:()=>l});var a=t(55141);class n extends a.u{constructor(i){super(),this.payload={exclude:i||[]}}}n.id="PLUGIN_RESET_ALL";class s extends a.u{constructor(i,e,t,a){super(),this.payload={name:i,config:e,configMeta:t,permissions:a||{}}}}s.id="PLUGIN_RELOAD";class o extends a.u{constructor(i,e,t,a){super(),this.payload={name:i,config:e,configMeta:t,permissions:a||{}}}}o.id="PLUGIN_LOAD";class l extends a.u{constructor(i){super(),this.payload={name:i}}}l.id="PLUGIN_UNLOAD";class r extends a.u{constructor(i,e){super(),this.payload={operation:i,callback:e}}}r.id="PLUGIN_CONFIG_FETCH_DATA";class d extends a.u{constructor(i,e){super(),this.payload={attachmentId:i,pluginId:e}}}d.id="ATTACHMENT_ASSOCIATE_WITH_PLUGIN";class c extends a.u{constructor(i,e){super(),this.payload={attachmentId:i,pluginId:e}}}c.id="ATTACHMENT_DISSOCIATE_FROM_PLUGIN"},31809:(i,e,t)=>{t.d(e,{kR:()=>y,nT:()=>u});var a=t(84710),n=t(56413),s=t(10843),o=t(43591),l=t(65746),r=t(64491),d=t(96540),c=t(40961);const h=new s.Ay("plugin-ui-data");var u;!function(i){i.OVERLAY="overlay",i.TAG_PANEL="tag-panel",i.TAG_HEADER="tag-header",i.TAG_OVERLAY="tag-overlay"}(u||(u={}));function g(i,e){return(0,d.createElement)("span",{className:i+"-slot-wrapper",ref:i=>null==i?void 0:i.appendChild(e),key:i})}class p{constructor(i,e="closed",t=document.createElement("div"),a=g(i,t),n=null){this.slotType=i,this.shadowRootMode=e,this.rawNode=t,this.reactNode=a,this.shadowRoot=n}getOrCreateShadowRoot(){return this.shadowRoot||(this.shadowRoot=this.rawNode.attachShadow({mode:this.shadowRootMode})),this.shadowRoot}hasShadowRoot(){return!!this.shadowRoot}clear(){return(0,c.unmountComponentAtNode)(this.rawNode),this.rawNode.remove(),this.rawNode=document.createElement("div"),this.shadowRoot=null,this.reactNode=g(this.slotType,this.rawNode),this}}class y extends a.B{constructor(i,e="closed"){var t;super(),this.parentMainDiv=i,this.shadowRootMode=e,this.name="plugin-ui-data",this.separator="Â¦",this.overlayRoot=document.createElement("div"),this.testSet=new Set,this.overlayRootAppended=!1,this.pluginOverlayElements=new n.E,this.pluginEmbeddedElements={[u.TAG_OVERLAY]:{},[u.TAG_PANEL]:{},[u.TAG_HEADER]:{},[u.OVERLAY]:{}},this.subs=[],this.mobile=(0,r.Fr)(),this.initOverlayRoot=()=>{this.overlayRootAppended||(this.parentMainDiv.appendChild(this.overlayRoot),this.overlayRootAppended=!0,this.grid=l.dn.init({column:16,margin:0,float:!0,animate:!1,row:16,alwaysShowResizeHandle:!0,resizable:{handles:"se, sw"},children:[{x:0,y:0,w:4,h:2,locked:!0,noMove:!0,noResize:!0}]},this.overlayRoot),this.resizeObserver=new o.A(this.resizeHandler),this.resizeObserver.observe(this.watchedElement))},this.watchedElement=null!==(t=this.parentMainDiv.getElementsByTagName("canvas")[0])&&void 0!==t?t:this.parentMainDiv,h.debug("PluginUIData loaded"),this.overlayRoot.classList.add("plugin-root-element","grid-stack"),this.initOverlayListeners(),this.resizeHandler=this.handleResize.bind(this)}getEmbeddable(i){const e=this.pluginEmbeddedElements[i];return Object.values(e).filter((i=>i.hasShadowRoot())).map((i=>i.reactNode))}handleResize(i=[]){if(!i.length)return;const e=Math.floor(this.overlayRoot.clientHeight/16);this.grid.cellHeight(e),this.overlayRoot.style.width=`${this.watchedElement.clientWidth}px`}registerOverlay(i,e,t){this.pluginOverlayElements.set(i,e),t&&(this.grid?this.grid.addWidget(e):h.warn("tried to register an overlay, but gridstack not initialized yet"))}createEmbeddedUi(i,e){return this.pluginEmbeddedElements[e][i]=new p(e,this.shadowRootMode)}getOrCreateEmbeddedUi(i,e,t){let a=this.pluginEmbeddedElements[e][i];return a||(a=this.createEmbeddedUi(i,e)),a.rawNode.classList.add(i),t||a.rawNode.classList.add("constrain-height"),a}createOverlay(i,e=!1){const t=document.createElement("div");return t.classList.add("plugin-overlay"),t.classList.add(i),e&&(t.classList.add("grid-stack-item"),t.setAttribute("gs-min-w",this.mobile?"2":"1"),t.setAttribute("gs-min-h",this.mobile?"2":"1")),this.registerOverlay(i,t,e),t}replaceOrCreateOverlay(i,e){let t=this.pluginOverlayElements.get(i);if(t&&(t.remove(),this.grid?this.grid.removeWidget(t):h.warn("[replaceOrCreate] tried to remove an overlay, but gridstack not initialized yet")),t=this.createOverlay(i,e),e){const i=document.createElement("span");return i.classList.add("grid-stack-item-content"),t.appendChild(i),i}return t}createRoots(i,e){return{[u.OVERLAY]:this.createOverlayRoot(i,e),[u.TAG_PANEL]:this.createRoot(i,u.TAG_PANEL),[u.TAG_HEADER]:this.createRoot(i,u.TAG_HEADER),[u.TAG_OVERLAY]:this.createRoot(i,u.TAG_OVERLAY,{expandOverlay:!0})}}createRoot(i,e,{expandOverlay:t=!1}={}){return this.getOrCreateEmbeddedUi(i,e,t)}createOverlayRoot(i,e){const t=this.replaceOrCreateOverlay(i,e.canPlaceInGrid);return new p(u.OVERLAY,this.shadowRootMode,t)}initOverlayListeners(){h.info("init plugin UI overlay"),this.subs.push(this.pluginOverlayElements.onElementChanged({onAdded:(i,e)=>{h.debug("added plugin overlay",e),this.initOverlayRoot(),i&&this.overlayRoot.appendChild(i)},onRemoved:(i,e)=>{h.debug("removed plugin overlay",e),i&&i.remove()}}))}disposeByKey(i){this.pluginOverlayElements.delete(i),Object.values(this.pluginEmbeddedElements).forEach((e=>{var t;null===(t=e[i])||void 0===t||t.clear()}))}dispose(){this.pluginOverlayElements.forEach(((i,e)=>{this.disposeByKey(e)})),this.subs.forEach((i=>i.cancel())),this.subs=[],this.grid.destroy(),this.resizeObserver.disconnect(),this.overlayRootAppended=!1,this.overlayRoot.remove()}}},378:(i,e,t)=>{t.r(e),t.d(e,{default:()=>P});var a=t(90082),n=t(71687),s=t(30877),o=t(75578),l=t(31809),r=t(32948),d=t(13586),c=t(56846),h=t(41122),u=t(25434),g=t(27947),p=t(22585),y=t(79070),m=t(91593),v=t(68593),f=t(25316),w=t(10843);class b{getFactory(i){return i.messengerFactory}}class P extends o.n{constructor(){super(...arguments),this.name="plugin",this.data=new r.C,this.allowLoad=!1,this.allowLiveReload=!0,this.pluginOverlayElements=new Map,this.applicationType=void 0,this.onResetPlugins=async({exclude:i})=>{await this.unloadPlugins(i),await this.loadConfigured(i)},this.onLoadPlugin=async({config:i,configMeta:e,permissions:t},a)=>{var n;if(this.allowLiveReload&&a){const s={properties:e,required:[]};for(const i of Object.keys(s.properties)){(null===(n=s.properties[i].required)||void 0===n?void 0:n.includes(i))&&s.required.push(i)}if(!this.jsonSchemaValidator.validate(s,i))return;const o={applicationKey:a.applicationKey,id:a.id};if(this.data.get(o))return;await this.load(Object.assign(Object.assign(Object.assign({},a),{config:i}),t))}},this.onUnloadPlugin=async i=>{if(this.allowLiveReload&&i){const e={applicationKey:i.applicationKey,id:i.id};await this.unload(e)}},this.onReloadPlugin=async({name:i,config:e,configMeta:t,permissions:a},n)=>{this.allowLiveReload&&(await this.onUnloadPlugin(n),this.debouncedOnLoadPlugin({name:i,config:e,configMeta:t,permissions:a},n))},this.debouncedOnReloadPlugin=(0,y.s)(this.onReloadPlugin,500),this.onReloadPluginCommand=async i=>{if(!this.allowLiveReload)return;let e=this.configuredPlugins.find((e=>e.id===i.name));e||(e=this.createLoadableConfig(i.name)),this.debouncedOnReloadPlugin(i,e)},this.debouncedOnLoadPlugin=(0,y.s)(this.onLoadPlugin,500),this.onLoadPluginCommand=async i=>{this.debouncedOnLoadPlugin(i,this.createLoadableConfig(i.name))},this.debouncedOnUnloadPlugin=(0,y.s)(this.onUnloadPlugin,500),this.onUnloadPluginCommand=async i=>{let e=this.configuredPlugins.find((e=>e.id===i.name));if(!e){const t=this.availablePlugins.get(i.name);t&&(e={applicationKey:t.applicationKey,id:t.name})}this.debouncedOnUnloadPlugin(e)},this.onFetchSdkDataCommand=async i=>{const e=await this.engine.diContainer.resolve("$ServiceSdk"),[t,...a]=i.operation.split(":"),n=t.split(".");let s;try{const t=n.reduce(((i,e)=>null==i?void 0:i[e]),e);if(!t)throw new Error(`Invalid SDK endpoint for ${i.operation}`);s=t.subscribe?await new Promise(((e,n)=>{const s=t.subscribe((t=>{if(s.cancel(),a.length>0)for(const e of a){if(void 0===t[e])return void n(new Error(`Invalid path ${a.join(".")} for ${i.operation}`));t=t[e]}e(t)}))})):await t()}catch(e){throw new Error("Failed to run command: "+i.operation)}i.callback(s)}}async init(i,e){if(this.jsonSchemaValidator=i.jsonSchemaValidator,this.commandBinder=e.commandBinder,[this.ses,this.sdk,this.pluginConfigDataModule,this.pluginUIData,this.settings,this.applicationData]=await Promise.all([e.getModuleBySymbol(n.JY),e.getModuleBySymbol(a.S1),e.getModuleBySymbol(n.lf),e.market.waitForData(l.kR),e.market.waitForData(f.o),e.market.waitForData(g.zH)]),this.separator=this.pluginUIData.separator,this.engine=e,this.allowLoad=i.pluginPolicies.enabled,this.allowLiveReload=this.allowLoad&&!this.pluginConfigDataModule.pluginConfigData.disabled&&!this.pluginConfigDataModule.pluginConfigData.preventLiveEdit,this.allowLoad&&(this.initializeServiceConnection(),await this.loadConfigured([],!0)),this.allowLoad){const i=e.subscribe(p.uv,(async({phase:t,application:a})=>{if(t===g.Jj.PLAYING)if(i.cancel(),this.applicationType=a,this.allowLiveReload){if(await this.loadConfigured(),!this.settings.getOverrideParam(c.L$,!1))if(this.applicationData.getName()===g.lg.WORKSHOP)await this.loadEditOnly();else{const t=e.subscribe(p.Fj,(async e=>{w.Ay.for(this).devInfo("Switch in active application detected by plugin system: ",e.application),e.application===g.lg.WORKSHOP&&(await this.loadEditOnly(),i.cancel())}));this.bindings.push(t)}}else w.Ay.for(this).devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",a),a===g.lg.SHOWCASE&&await this.loadConfigured(),this.bindings.push(e.subscribe(p.Fj,(async i=>{if(w.Ay.for(this).devInfo("Switch in active application detected by plugin system: ",i.application),i.application===g.lg.WORKSHOP)try{await this.disposeAll()}catch(i){w.Ay.for(this).debugWarn("Entering workshop, one or more plugins failed to dispose properly:",i)}else i.application===g.lg.SHOWCASE&&await this.loadConfigured()})))}))}this.bindings.push(e.commandBinder.addBinding(h.ho,this.onResetPlugins),e.commandBinder.addBinding(h.YB,this.onReloadPluginCommand),e.commandBinder.addBinding(h.nq,this.onLoadPluginCommand),e.commandBinder.addBinding(h.u3,this.onUnloadPluginCommand),e.commandBinder.addBinding(h.My,this.onFetchSdkDataCommand),e.commandBinder.addBinding(m.J,this.handlePluginVisibility.bind(this))),e.market.register(r.C,this.data)}initializeServiceConnection(){const i=this.pluginConfigDataModule.serviceSdkKey;this.engine.diContainer.bindAsyncFactory("$ServiceSdk",(()=>s.p.connect({connect:()=>this.sdk.connectPlugin(i,"PluginConfigRootConnection"),cancelConnecting:()=>{}},new b,window)))}async handlePluginVisibility(i){for(const e of i.ids)this.data.visibilityData.set(e,i.value),this.toggleVisibility(e,i.value)}toggleVisibility(i,e){var t;null===(t=this.pluginOverlayElements.get(i))||void 0===t||t.classList.toggle("hidden",!e),this.commandBinder.issueCommand(new v.b(i,e))}broadcastLoadEvent(i){this.engine.broadcast(new u.u(i.id,i.src,Date.now()-performance.timing.navigationStart))}async loadEditOnly(){var i,e;this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins;const t=this.availablePlugins.values.filter((i=>{var e;return null===(e=i.options)||void 0===e?void 0:e.editOnly}));if(t.length>0){const a=t.map((i=>i.name));w.Ay.for(this).debug("Loading editOnly plugins: "+a.join(", "));const n=[];for(const a of t){const t={id:a.name,src:a.src,config:a.config,outputs:a.outputs,applicationKey:a.applicationKey,strict:a.strict,peerDependencies:a.peerDependencies,canPlaceInGrid:null===(i=a.options)||void 0===i?void 0:i.canPlaceInGrid,hideViewToggle:null===(e=a.options)||void 0===e?void 0:e.hideViewToggle};n.push(this.load(t).then((()=>{this.broadcastLoadEvent(t)})))}await Promise.all(n)}}async loadConfigured(i=[],e=!1){if(!this.pluginConfigDataModule.pluginConfigData.disabled)return this.pluginConfigDataModule.registryLoaded?void await this.updatePluginDataAndLoad(i,e):new Promise((t=>{this.registrySubscription=this.pluginConfigDataModule.registryLoadedObservable.onChanged((async a=>{a&&(await this.updatePluginDataAndLoad(i,e),t())}))}));w.Ay.for(this).debug("Cannot load plugins! Disabled by URL parameter.")}async updatePluginDataAndLoad(i,e){this.configuredPlugins=await this.pluginConfigDataModule.getConfiguredPlugins(this.applicationType,e),this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins,this.data.visibilityData.replace(this.configuredPlugins.filter((i=>!i.hideViewToggle)).reduce(((i,e)=>{var t;return i[e.id]=null===(t=this.data.visibilityData.get(e.id))||void 0===t||t,i}),{})),w.Ay.for(this).debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(this.configuredPlugins,void 0,2)),await this.waitForPluginLoad(i)}async waitForPluginLoad(i){var e;if(!this.configuredPlugins)return void w.Ay.for(this).error("Waiting for load before plugin records fetched.");const t=[];for(const i of this.configuredPlugins){const e={applicationKey:i.applicationKey,id:i.id};this.data.get(e)||t.push(this.load(i).then((()=>{this.broadcastLoadEvent(i)})))}try{await Promise.all(t)}catch(i){w.Ay.for(this).warn("Issues were encountered loading configured plugins.")}for(const t of this.pluginOverlayElements.keys()){if(i.includes(t))continue;const a=this.data.visibilityData.get(t);null===(e=this.pluginOverlayElements.get(t))||void 0===e||e.classList.toggle("hidden",!a)}}async fetchPlugin(i,e,t,a,n){a.strict&&this.ses.freezeForStrict();const s=await this.ses.makeSecureEnvironment(i+`${t?this.separator+t:""}`,e,a,this.pluginConfigDataModule.pluginConfigData.eventTarget,n);if(s){return[s,s.compartment.globalThis.plugin]}return null}async unload(i){const e=i.id&&""!==i.id?i.id:"default",t={applicationKey:i.applicationKey,id:e},a=this.data.get(t);let n=null;if(a){try{n=a.dispose()}catch(i){w.Ay.for(this).warn("An error occurred when disposing a plugin, it may be in a partially disposed state",i)}this.data.delete(t)}return n||Promise.resolve()}async load(i){var e;const{applicationKey:t,src:a,id:n,strict:s,fetchLevel:o=d.D.None,peerDependencies:l,canPlaceInGrid:r}=i;if(!this.allowLoad){const i=a.startsWith("http")?a:`${a.substring(0,16)}...`;return Promise.reject(`Load for plugin <${n}:${i}> requested, but plugin system is not available.`)}if(t.includes(this.separator))return Promise.reject(`Application Key cannot contain the separator character: ${this.separator}`);if(n.includes(this.separator))return Promise.reject(`Plugin ID cannot contain the separator character: ${this.separator}`);const c=void 0===s||s,h=n||"default",u={applicationKey:t,id:h};if(this.data.get(u))return Promise.reject(`Plugin for ${t}-${h} already loaded.`);const g={strict:c,canFetch:o>=d.D.AnonymousFetch,canFetchAsUser:o>=d.D.UserFetch,canStoreLocal:!0,canPlaceInGrid:r||!1,shadowRootMode:"closed"},[p,y]=await this.fetchPlugin(t,a,h,g,l)||[];if(p&&y){const a=null===(e=p.overlayElement)||void 0===e?void 0:e.querySelector(`.${t}${this.separator}${n}`);a&&!i.hideViewToggle&&(this.pluginOverlayElements.set(h,a),this.data.visibilityData.set(h,!0)),await this.initPlugin(p,y.factory,i,h)}}async initPlugin(i,e,t,a){const n=e(),{applicationKey:o,id:l,config:r}=t;let d=()=>{};const c=n.onInit||n.init;let h=Promise.resolve();if(c){class i{constructor(i){this.sdk=i}connect(){return this.sdk.connectPlugin(o,l)}cancelConnecting(){}}const e=await s.p.connect(new i(this.sdk),new b,window);h=c.call(n,e,r),d=()=>e.disconnect()}const u=this.pluginConfigDataModule.pluginConfigData.eventTarget,g=this.setupVisibilityEvents(u);async function p(){const e=n.onDestroy||n.dispose;return((null==e?void 0:e.call(n))||Promise.resolve()).finally((()=>{d(),g.cancel(),u.delete(a),i.dispose()}))}const y={applicationKey:o,id:l};try{return await h,this.data.set(y,n,p),Promise.resolve()}catch(i){w.Ay.for(this).warn("Plugin initialization failed: ",i),w.Ay.for(this).debugWarn("Attemptying dispose for clean up...");try{await p()}catch(i){w.Ay.for(this).warn("Auto-cleanup of plugin had errors: ",i)}return Promise.reject(i)}}setupVisibilityEvents(i){const e=async(i,e)=>{"_CLOSE_"===i.name&&await this.engine.commandBinder.issueCommand(new m.J([e],!1))};return i.onElementChanged({onAdded:e,onUpdated:e})}dispose(i){super.dispose(i),this.registrySubscription.cancel(),this.disposeAll().catch((i=>{w.Ay.for(this).warn("One or more plugins failed to dispose properly.",i)}))}disposeAll(){return this.configuredPlugins=[],this.unloadPlugins()}unloadPlugins(i=[]){w.Ay.for(this).devInfo("Unloading all plugins...except: "+i.join(", "));const e=[];for(const[t,a]of this.data.plugins.entries()){const n=t.split(".")[1];i.includes(n)||(e.push(a.dispose()),this.data.plugins.delete(t))}return Promise.all(e)}createLoadableConfig(i){var e,t;const a=this.availablePlugins.get(i),{src:n,config:s,applicationKey:o,strict:l,outputs:r,peerDependencies:d}=a;return{id:i,src:n,config:s,outputs:r,applicationKey:o,strict:l,peerDependencies:d,canPlaceInGrid:null===(e=a.options)||void 0===e?void 0:e.canPlaceInGrid,hideViewToggle:null===(t=a.options)||void 0===t?void 0:t.hideViewToggle}}}},68593:(i,e,t)=>{t.d(e,{b:()=>n});var a=t(55141);class n extends a.u{constructor(i,e){super(),this.payload={owner:i,isVisible:e}}}n.id="TOGGLE_SCENES_BY_OWNER"}}]);